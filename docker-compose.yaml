services:
  # PostgreSQL Database
  db:
    image: postgres:17-alpine
    container_name: piggy-pulse-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-example}
      POSTGRES_DB: piggy_pulse_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - piggy-pulse-network

  # Backend (Rust/Rocket)
  backend:
    build:
      context: ../piggy-pulse-api
      dockerfile: ../piggy-pulse-api-app/Dockerfile.backend
    container_name: piggy-pulse-api
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://postgres:${DB_PASSWORD:-example}@db:5432/piggy_pulse_db
      PIGGY_PULSE_DATABASE__URL: postgres://postgres:${DB_PASSWORD:-example}@db:5432/piggy_pulse_db
      PIGGY_PULSE_DATABASE__MAX_CONNECTIONS: 10
      PIGGY_PULSE_DATABASE__MIN_CONNECTIONS: 1
      PIGGY_PULSE_DATABASE__CONNECTION_TIMEOUT: 120
      PIGGY_PULSE_DATABASE__ACQUIRE_TIMEOUT: 120
      PIGGY_PULSE_SERVER__ADDRESS: 0.0.0.0
      PIGGY_PULSE_SERVER__PORT: 8000
      PIGGY_PULSE_API__EXPOSE_DOCS: true
      PIGGY_PULSE_CORS__ALLOWED_ORIGINS: '["https://localhost", "https://127.0.0.1", "https://192.168.1.34"]'
      PIGGY_PULSE_CORS__ALLOW_CREDENTIALS: "true"
      PIGGY_PULSE_RATE_LIMIT__USE_FORWARDED_IP: "true"
      PIGGY_PULSE_RATE_LIMIT__FORWARDED_IP_HEADER: x-forwarded-for
      PIGGY_PULSE_SESSION__COOKIE_SECURE: "true"
      ROCKET_SECRET_KEY: ${ROCKET_SECRET_KEY}
      ROCKET_ADDRESS: 0.0.0.0
      ROCKET_PORT: 8000
      RUST_LOG: ${RUST_LOG:-info}
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - piggy-pulse-network

  # Frontend (React/Vite)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: piggy-pulse-frontend
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - piggy-pulse-network

  # Caddy Reverse Proxy
  caddy:
    build:
      context: .
      dockerfile: Dockerfile.caddy
    container_name: piggy-pulse-caddy
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - piggy-pulse-network

  # Database Admin (optional - only run with --profile debug)
  adminer:
    image: adminer:latest
    container_name: piggy-pulse-adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: db
    depends_on:
      - db
    profiles:
      - debug
    networks:
      - piggy-pulse-network

volumes:
  postgres_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local

networks:
  piggy-pulse-network:
    driver: bridge
