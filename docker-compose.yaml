services:
  # PostgreSQL Database
  db:
    image: postgres:17-alpine
    container_name: budget-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-example}
      POSTGRES_DB: budget_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - budget-network

  # Backend (Rust/Rocket)
  backend:
    build:
      context: ../budget
      dockerfile: ../budget-app/Dockerfile.backend
    container_name: budget-backend
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://postgres:${DB_PASSWORD:-example}@db:5432/budget_db
      BUDGET__DATABASE__URL: postgres://postgres:${DB_PASSWORD:-example}@db:5432/budget_db
      BUDGET__DATABASE__MAX_CONNECTIONS: 10
      BUDGET__DATABASE__MIN_CONNECTIONS: 1
      BUDGET__DATABASE__CONNECTION_TIMEOUT: 120
      BUDGET__DATABASE__ACQUIRE_TIMEOUT: 120
      BUDGET__SERVER__ADDRESS: 0.0.0.0
      BUDGET__SERVER__PORT: 8000
      BUDGET_CORS__ALLOWED_ORIGINS: '["https://localhost", "https://127.0.0.1", "https://192.168.1.34"]'
      BUDGET_CORS__ALLOW_CREDENTIALS: "true"
      BUDGET_RATE_LIMIT__USE_FORWARDED_IP: "true"
      BUDGET_RATE_LIMIT__FORWARDED_IP_HEADER: x-forwarded-for
      BUDGET_SESSION__COOKIE_SECURE: "true"
      ROCKET_SECRET_KEY: ${ROCKET_SECRET_KEY}
      ROCKET_ADDRESS: 0.0.0.0
      ROCKET_PORT: 8000
      RUST_LOG: ${RUST_LOG:-info}
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - budget-network

  # Frontend (React/Vite)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: budget-frontend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - budget-network

  # Caddy Reverse Proxy
  caddy:
    build:
      context: .
      dockerfile: Dockerfile.caddy
    container_name: budget-caddy
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - budget-network

  # Database Admin (optional - only run with --profile debug)
  adminer:
    image: adminer:latest
    container_name: budget-adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: db
    depends_on:
      - db
    profiles:
      - debug
    networks:
      - budget-network

volumes:
  postgres_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local

networks:
  budget-network:
    driver: bridge
